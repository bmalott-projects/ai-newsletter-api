name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install ".[dev]"
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: Run ruff linting
        run: ruff check .

      - name: Run ruff formatting check
        run: ruff format --check .

  typecheck:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install ".[dev]"
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: Run basedpyright type checking
        run: basedpyright --project pyproject.toml

  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: ai_newsletter_test
        ports:
          - "5432:5432"
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          REDIS_DB: 0
        ports:
          - "6379:6379"
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      # Set required environment variables (including test database URL since its required for tests)
      API_PORT: 8000
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: ai_newsletter_test
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      REDIS_DB: 0
      OPENAI_API_KEY: test_key_not_used
      JWT_SECRET_KEY: TestSecretKeyForCI123!@#WithEnoughLength
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: 30
      TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/ai_newsletter_test
      ENVIRONMENT: test

    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install ".[dev]"
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: Wait for PostgreSQL
        run: |
          .venv/bin/python - <<'PY'
          import asyncio
          import asyncpg
          import sys

          async def check_db() -> None:
              for i in range(30):
                  try:
                      conn = await asyncpg.connect(
                          host="localhost",
                          port=5432,
                          user="postgres",
                          password="postgres",
                          database="ai_newsletter_test",
                      )
                      await conn.close()
                      print("PostgreSQL is ready!")
                      return
                  except Exception:
                      if i == 29:
                          print("PostgreSQL failed to start")
                          sys.exit(1)
                      await asyncio.sleep(1)

          asyncio.run(check_db())
          PY

      - name: Run full test suite
        run: pytest -v
